<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./libs/d3.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <title>Chile</title>
    <style>
        path:hover {
            opacity: .6;
            stroke: black;
            stroke-width: 4px;
        }
    </style>
</head>

<body>
    <div id="header" style="width: 100%; margin: auto;">
    <h1 style="text-align: center">Wine Production and Trade - Chile</h1>
    </div>
    <table>
        <tr>
            <td><div id="container1" style="width: 45vw; height: 80vh;"> </div></td>
            <!-- <td><div id="container2" style="width: 50vw; height: 80vh; overflow-y: auto;"> </div></td> -->
            <td><div id="container2" style="width: 50vw; height: 80vh;"> </div></td>
        </tr>
    </table>
    <script>
        const exportDataFile = "data/exportChile.json"
        const prodDataFile = "data/chileProduction.json"
        const tradeDataFile = "data/chile_2019_trade.json"
        const OIV_data = "data/OIV_data.csv"

        // load both files
        Promise.all([
            d3.json(tradeDataFile),
            d3.dsv(';', OIV_data)
        ]).then(data => {
            const OIVData = data[1]

            const countryName = 'Chile'
            let countryData = OIVData.filter(d => d.Country === countryName)
            let importData2 = countryData.filter(d => d.Series === 'Wine imports')
            let exportData2 = countryData.filter(d => d.Series === 'Wine exports')
            let prodData2 = countryData.filter(d => d.Series === 'Wine production')

            function mapOIV(d) {
                return {
                    year: +d.Year,
                    hectolitres: +d.Value
                }
            }

            let importData = d3.map(importData2, mapOIV)
            let exportData = d3.map(exportData2, mapOIV)
            let prodData = d3.map(prodData2, mapOIV)

            function annualChart() {
                const exportValues = d3.map(exportData, d => +d.hectolitres)
                const importValues = d3.map(importData, d => +d.hectolitres)
                const prodValues = d3.map(prodData, d => +d.hectolitres)
                const allValues = importValues.concat(exportValues).concat(prodValues)
                const years = d3.map(importData, d => +d.year)

                const width = 1000
                const height = 800
                const svg_width = "40vw"
                const svg_height = "80vh"
                const viewBox = "0 0 1000 800"

                const margin = {top: 20, left: 50, right: 20, bottom: 20}
                const svg = d3.select("#container1")
                    .append("svg")
                    .attr("width", svg_width)
                    .attr("height", svg_height)
                    .attr("viewBox", viewBox)

                const xScale = d3.scaleBand()
                    .domain(years)
                    .rangeRound([margin.left, width - margin.right])

                const yScale = d3.scaleLinear()
                    .domain(d3.extent(allValues))
                    .range([height - margin.bottom, margin.top])

                // Draw Axes
                const xAxis = svg.append("g")
                    .attr("transform", `translate(${0},${height - margin.bottom})`)
                    .call(d3.axisBottom().scale(xScale))
                const yAxis = svg.append("g")
                    .attr("transform", `translate(${margin.left},${0})`)
                    .call(d3.axisLeft().scale(yScale))

                // Bind data, and draw rectangles
                const barWidth = 10;
                const importBars = svg.selectAll('.rects')
                    .data(importData)
                    .enter()
                    .append("rect")
                    .attr("x", d => xScale(d.year) + xScale.bandwidth() / 2 - barWidth)
                    .attr("y", d => yScale(d.hectolitres))
                    .attr("width", barWidth)
                    .attr("height", d => height - margin.bottom - yScale(d.hectolitres))
                    .attr("fill", "blue")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", .8)
                const exportBars = svg.selectAll('.rects')
                    .data(exportData)
                    .enter()
                    .append("rect")
                    .attr("x", d => xScale(d.year) + xScale.bandwidth() / 2)
                    .attr("y", d => yScale(d.hectolitres))
                    .attr("width", barWidth)
                    .attr("height", d => height - margin.bottom - yScale(d.hectolitres))
                    .attr("fill", "red")
                    .attr("stroke", "#b48246")
                    .attr("stroke-width", .8)

                // Use line generator to make path element attributes (d)
                const lineGen = d3.line()
                    .x(d => xScale(d.year))
                    .y(d => yScale(d.hectolitres))

                // Bind data, and add path element with attributes
                const lineChart = svg.selectAll('.Line')
                    .data([prodData])
                    .enter()
                    .append("path")
                    .attr("d", d => lineGen(d))
                    .attr("fill", "none")
                    .attr("stroke", "green")
                    .attr("stroke-width", 1.5)
            }

            function partnersChart(tradeDataOrig)
            {
                //sort bars based on value
                let tradeData = tradeDataOrig.sort(function (a, b) {
                    return d3.ascending(+a.imports, +b.imports);
                })

                //let tradeData = d3.map(tradeDataOrig, d => d)
                const exportValues = d3.map(tradeData, d => +d.exports)
                const importValues = d3.map(tradeData, d => +d.imports)
                const allValues = exportValues.concat(importValues)
                const countries = d3.map(tradeData, d => d.country)

                const importBarHeight = 10;
                const margins = { top: 15, right: 25, bottom: 15, left: 80 };

                const fullWidth = 600
                //const fullHeight = 2000
                const fullHeight = ((tradeData.length + 2) * importBarHeight) + margins.top + margins.bottom
                const svg_width = "50vw"
                const svg_height = "80vh"
                const viewBox = "0 0 600 " + fullHeight


                // originally based on https://bl.ocks.org/hrecht/f84012ee860cb4da66331f18d588eee3



                const width = fullWidth - margins.left - margins.right
                const height = fullHeight - margins.top - margins.bottom

                const svg = d3.select("#container2")
                    .append("svg")
                    .attr("width", svg_width)
                    //.attr("height", svg_height)
                    .attr("viewBox", viewBox)
                    .append("g")
                    .attr("transform", "translate(" + margins.left + "," + margins.top + ")");

                const xScale = d3.scaleLinear()
                    .range([0, width])
                    .domain([0, d3.max(allValues)])

                const yScale = d3.scaleBand()
                    .domain(countries)
                    .range([height, 0])

                const yAxis = svg.append("g")
                    .call(d3.axisLeft().scale(yScale).tickSize(0))


                let bars = svg.selectAll(".bar")
                    .data(tradeData)
                    .enter()
                    .append("g")

                // Add bars to show imports
                bars.append("rect")
                    .attr("y", function (d) { return yScale(d.country); })
                    .attr("height", importBarHeight)
                    .attr("x", 0)
                    .attr("width", function (d) { return xScale(d.imports); })
                    .attr("fill","lightblue")
                    .attr("stroke","steelblue")
                    .attr("stroke-width",.8)

                // Add bars to show exports
                const exportBarHeight = 4;
                bars.append("rect")
                    .attr("y", function (d) { return yScale(d.country) + 3; })
                    .attr("height", exportBarHeight)
                    .attr("x", 0)
                    .attr("width", function (d) { return xScale(d.exports); })
                    .attr("fill","red")
                    .attr("stroke","black")
                    .attr("stroke-width",.8)
            }

            annualChart()
            partnersChart(data[0])
        })
    </script>
</body>

</html>
